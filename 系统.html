<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‘£äº‹ä¼šå†³ç­–å®éªŒç³»ç»Ÿ</title>
    <!-- æ·»åŠ  CryptoJS åº“ç”¨äºç”Ÿæˆç­¾å -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- æ›¿æ¢ä¸ºæ›´å¯é çš„äºŒç»´ç åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        /* æ‰€æœ‰åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        
        .experiment-area {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .role-info {
            background-color: var(--light-color);
        }
        
        .role-info h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #bdc3c7;
        }
        
        .role-details {
            margin-top: 15px;
        }
        
        .role-details p {
            margin-bottom: 10px;
        }
        
        .proposal-area {
            min-height: 300px;
            position: relative;
        }
        
        .proposal-content {
            margin-top: 15px;
            line-height: 1.8;
            white-space: pre-line;
        }
        
        .ai-interaction {
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-y: auto;
            max-height: 300px;
            background-color: #f9f9f9;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .user-message {
            background-color: var(--secondary-color);
            color: white;
            margin-left: auto;
        }
        
        .ai-message {
            background-color: #e1e1e1;
            color: var(--dark-color);
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .chat-input button {
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .timer-area {
            text-align: center;
            padding: 15px;
            background-color: var(--dark-color);
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .timer {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .voting-area {
            text-align: center;
            padding: 20px;
        }
        
        .voting-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .vote-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .approve {
            background-color: var(--success-color);
            color: white;
        }
        
        .oppose {
            background-color: var(--accent-color);
            color: white;
        }
        
        .abstain {
            background-color: var(--warning-color);
            color: white;
        }
        
        .vote-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .phase-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .phase {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #ddd;
            border-radius: 4px;
            margin: 0 5px;
        }
        
        .phase.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .risk-alert {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .risk-alert.show {
            display: block;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
        }
        
        .login-form input, .login-form button {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .login-form button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .hidden {
            display: none;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th, .results-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .results-table th {
            background-color: var(--light-color);
        }
        
        .next-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .next-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .phase-instruction {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .no-ai-message {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .ai-choice-container {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .ai-choice-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .ai-choice-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .use-ai-btn {
            background-color: var(--success-color);
            color: white;
        }
        
        .no-ai-btn {
            background-color: #95a5a6;
            color: white;
        }
        
        .ai-choice-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* ç®¡ç†åå°æ ·å¼ */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--secondary-color);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .export-buttons {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        
        .export-btn {
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .admin-login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-container {
            margin: 20px 0;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .login-options {
            text-align: center;
            margin-top: 20px;
        }
        
        .login-option-btn {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .login-option-btn.primary {
            background-color: var(--secondary-color);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .api-key-setup {
            background: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .conversation-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .connection-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .status-connected {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-disconnected {
            background-color: #95a5a6;
            color: white;
        }
        
        .status-error {
            background-color: var(--accent-color);
            color: white;
        }

        /* æ–°å¢æ ·å¼ï¼šç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .experiment-area {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .panel {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .chat-input {
                flex-direction: column;
            }
            
            .chat-input input {
                margin-bottom: 10px;
            }
            
            .voting-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .vote-btn {
                width: 100%;
                padding: 12px;
            }
            
            .phase-indicator {
                flex-direction: column;
                gap: 5px;
            }
            
            .phase {
                margin: 2px 0;
            }
            
            /* è§¦æ‘¸å‹å¥½çš„æŒ‰é’®å¤§å° */
            button, .vote-btn, .next-button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* ä¼˜åŒ–å­—ä½“å¤§å° */
            body {
                font-size: 14px;
            }
            
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.3rem; }
            h3 { font-size: 1.1rem; }

            .login-container {
                margin: 20px auto;
                padding: 20px;
            }
        }

        /* å¹³æ¿é€‚é… */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 15px;
            }
            
            .experiment-area {
                grid-template-columns: 280px 1fr;
            }
        }

        /* å¼•å¯¼é—®é¢˜æ ·å¼ */
        .guide-questions {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .guide-questions h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .guide-btn {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: left;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .guide-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* äºŒç»´ç åŒºåŸŸæ ·å¼ */
        .qr-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #3498db;
        }

        .qr-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        #qrcode {
            margin: 15px auto;
            display: inline-block;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .qr-link {
            margin-top: 15px;
            font-size: 0.9em;
        }

        .qr-link a {
            color: #3498db;
            word-break: break-all;
            text-decoration: underline;
        }

        .deploy-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .deploy-notice h4 {
            color: #856404;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é€‰æ‹©ç•Œé¢ -->
    <div id="loginSelectionScreen" class="container">
        <div class="login-container">
            <h2>è‘£äº‹ä¼šå†³ç­–å®éªŒç³»ç»Ÿ</h2>
            
            <!-- éƒ¨ç½²è¯´æ˜ -->
            <div class="deploy-notice">
                <h4>ğŸ“± ç§»åŠ¨ç«¯è®¿é—®è¯´æ˜</h4>
                <p>ä¸ºäº†åœ¨æ‰‹æœºä¸Šæ­£å¸¸ä½¿ç”¨ï¼Œè¯·å°†æœ¬ç³»ç»Ÿéƒ¨ç½²åˆ°WebæœåŠ¡å™¨ï¼š</p>
                <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                    <li>ä½¿ç”¨GitHub Pagesã€Vercelæˆ–Netlifyç­‰å¹³å°éƒ¨ç½²</li>
                    <li>ç¡®ä¿ä½¿ç”¨HTTPSåè®®è®¿é—®</li>
                    <li>æ‰‹æœºæ‰«æäºŒç»´ç å³å¯ç›´æ¥å‚ä¸å®éªŒ</li>
                </ol>
            </div>
            
            <!-- APIé…ç½®åŒºåŸŸ - åªåœ¨é¦–æ¬¡éœ€è¦ -->
            <div class="api-key-setup" id="apiSetupArea">
                <h4>é¦–æ¬¡ä½¿ç”¨ï¼šè®¯é£æ˜Ÿç«APIè®¾ç½®</h4>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    æ ¼å¼: APIKey:APISecret:AppID<br>
                    ç¤ºä¾‹: key123:secret456:app789
                </p>
                <input type="password" id="apiPasswordInput" placeholder="è¾“å…¥APIKey:APISecret:AppID" style="width: 100%; margin: 5px 0; padding: 8px;">
                <button onclick="saveAPIPassword()" style="width: 100%; padding: 8px;">ä¿å­˜APIé…ç½®</button>
            </div>
            
            <!-- äºŒç»´ç ç”ŸæˆåŒºåŸŸ -->
            <div class="qr-section" id="qrSection" style="display: none;">
                <h4>æ‰«æäºŒç»´ç åŠ å…¥å®éªŒ</h4>
                <div id="qrcode"></div>
                <div class="qr-link" id="qrLink"></div>
                <p style="font-size: 0.9em; color: #666; margin-top: 15px;">
                    æ‰«ææ­¤äºŒç»´ç å³å¯ç›´æ¥è¿›å…¥å®éªŒï¼Œæ— éœ€é‡å¤é…ç½®API
                </p>
            </div>
            
            <div class="login-options">
                <button class="login-option-btn primary" id="participantLoginBtn">å‚ä¸è€…ç™»å½•</button>
                <button class="login-option-btn" id="adminLoginBtn">ç®¡ç†å‘˜ç™»å½•</button>
                <button class="login-option-btn" id="generateQRBtn" style="background-color: #9b59b6;">ç”Ÿæˆå‚ä¸äºŒç»´ç </button>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <p><strong>ç³»ç»Ÿç»Ÿè®¡:</strong></p>
                <p>æ€»å‚ä¸äººæ•°: <span id="totalParticipants">0</span></p>
                <p>äººæœºåä½œç»„: <span id="humanAiGroupCount">0</span> äºº</p>
                <p>å…¨äººç±»ç»„: <span id="humanOnlyGroupCount">0</span> äºº</p>
            </div>

            <p id="apiSetupStatus" style="font-size: 0.8em; color: #666; margin-top: 10px; text-align: center;">
                æç¤ºï¼šéœ€è¦è®¯é£æ˜Ÿç«Spark LiteæœåŠ¡çš„APIé…ç½®æ‰èƒ½ä½¿ç”¨AIåŠ©æ‰‹åŠŸèƒ½
            </p>
        </div>
    </div>

    <!-- å…¶ä»–ç•Œé¢ä¿æŒä¸å˜ -->
    <!-- å‚ä¸è€…ç™»å½•ç•Œé¢ -->
    <div id="participantLoginScreen" class="container hidden">
        <!-- å†…å®¹ä¿æŒä¸å˜ -->
    </div>

    <!-- ç®¡ç†å‘˜ç™»å½•ç•Œé¢ -->
    <div id="adminLoginScreen" class="container hidden">
        <!-- å†…å®¹ä¿æŒä¸å˜ -->
    </div>

    <!-- å®éªŒä¸»ç•Œé¢ -->
    <div id="experimentScreen" class="container hidden">
        <!-- å†…å®¹ä¿æŒä¸å˜ -->
    </div>

    <!-- å‚ä¸è€…ç»“æœç•Œé¢ -->
    <div id="resultsScreen" class="container hidden">
        <!-- å†…å®¹ä¿æŒä¸å˜ -->
    </div>

    <!-- ç®¡ç†åå°ç•Œé¢ -->
    <div id="adminScreen" class="admin-container hidden">
        <!-- å†…å®¹ä¿æŒä¸å˜ -->
    </div>

    <script>
        // ==================== æ•°æ®å­˜å‚¨å’ŒAPIé…ç½® ====================
        
        // æ•°æ®å­˜å‚¨é”®å
        const STORAGE_KEYS = {
            EXPERIMENT_DATA: 'board_experiment_data',
            XUNFEI_API_PASSWORD: 'xunfei_api_password'
        };

        // è·å–è®¯é£APIå¯†ç 
        function getXunfeiAPIPassword() {
            return localStorage.getItem(STORAGE_KEYS.XUNFEI_API_PASSWORD);
        }

        // ä¿å­˜è®¯é£APIé…ç½®
        function saveAPIPassword() {
            const apiPassword = document.getElementById('apiPasswordInput').value.trim();
            
            if (apiPassword) {
                // éªŒè¯æ ¼å¼
                const parts = apiPassword.split(':');
                if (parts.length !== 3) {
                    alert('APIé…ç½®æ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨: APIKey:APISecret:AppID');
                    return;
                }
                
                localStorage.setItem(STORAGE_KEYS.XUNFEI_API_PASSWORD, apiPassword);
                alert('è®¯é£æ˜Ÿç«APIé…ç½®å·²ä¿å­˜ï¼');
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('apiPasswordInput').value = '';
                
                updateAPIStatus();
                updateAPISetupDisplay();
            } else {
                alert('è¯·è¾“å…¥APIé…ç½®');
            }
        }

        // æ›´æ–°APIé…ç½®æ˜¾ç¤ºçŠ¶æ€
        function updateAPISetupDisplay() {
            const hasConfig = !!getXunfeiAPIPassword();
            const apiSetupArea = document.getElementById('apiSetupArea');
            const apiSetupStatus = document.getElementById('apiSetupStatus');
            
            if (hasConfig) {
                apiSetupArea.style.display = 'none';
                apiSetupStatus.innerHTML = 'âœ… APIå·²é…ç½®ï¼Œå¯ä»¥ç”ŸæˆäºŒç»´ç é‚€è¯·ä»–äººå‚ä¸';
                apiSetupStatus.style.color = '#27ae60';
            } else {
                apiSetupArea.style.display = 'block';
                apiSetupStatus.innerHTML = 'âŒ éœ€è¦è®¯é£æ˜Ÿç«Spark LiteæœåŠ¡çš„APIPasswordæ‰èƒ½ä½¿ç”¨AIåŠ©æ‰‹åŠŸèƒ½';
                apiSetupStatus.style.color = '#e74c3c';
            }
        }

        // ==================== ä¿®å¤çš„äºŒç»´ç ç”ŸæˆåŠŸèƒ½ ====================

        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            console.log('å¼€å§‹ç”ŸæˆäºŒç»´ç ...');
            
            const apiPassword = getXunfeiAPIPassword();
            if (!apiPassword) {
                alert('è¯·å…ˆé…ç½®APIå¯†ç æ‰èƒ½ç”ŸæˆäºŒç»´ç ');
                return;
            }
            
            // æ˜¾ç¤ºäºŒç»´ç åŒºåŸŸ
            document.getElementById('apiSetupArea').style.display = 'none';
            const qrSection = document.getElementById('qrSection');
            qrSection.style.display = 'block';
            
            // ç”ŸæˆåŒ…å«APIé…ç½®çš„URLï¼ˆä½¿ç”¨åŠ å¯†ï¼‰
            const encryptedConfig = btoa(apiPassword);
            
            // åˆ›å»ºåœ¨çº¿éƒ¨ç½²çš„ç¤ºä¾‹URLï¼ˆå®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ä¸ºä½ çš„éƒ¨ç½²åœ°å€ï¼‰
            let shareableURL;
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æœ¬åœ°æ–‡ä»¶åè®®
            if (window.location.protocol === 'file:') {
                // æœ¬åœ°æ–‡ä»¶ç¯å¢ƒï¼Œæä¾›éƒ¨ç½²è¯´æ˜
                shareableURL = 'https://ä½ çš„åŸŸå.com/ç³»ç»Ÿ.html?config=' + encryptedConfig;
                alert('âš ï¸ å½“å‰ä¸ºæœ¬åœ°æ–‡ä»¶ç¯å¢ƒï¼ŒäºŒç»´ç é“¾æ¥ä¸ºç¤ºä¾‹ã€‚\n\nè¯·å°†ç³»ç»Ÿéƒ¨ç½²åˆ°WebæœåŠ¡å™¨åï¼Œä½¿ç”¨å®é™…çš„HTTPSé“¾æ¥ç”ŸæˆäºŒç»´ç ã€‚');
            } else {
                // WebæœåŠ¡å™¨ç¯å¢ƒï¼Œä½¿ç”¨å½“å‰URL
                shareableURL = `${window.location.origin}${window.location.pathname}?config=${encryptedConfig}`;
            }
            
            console.log('ç”Ÿæˆçš„åˆ†äº«URL:', shareableURL);
            
            // ç”ŸæˆäºŒç»´ç  - ä½¿ç”¨æ–°çš„äºŒç»´ç åº“
            const qrcodeElement = document.getElementById('qrcode');
            qrcodeElement.innerHTML = ''; // æ¸…ç©ºåŸæœ‰å†…å®¹
            
            try {
                // ä½¿ç”¨ qrcode-generator åº“
                const typeNumber = 0; // è‡ªåŠ¨ç±»å‹
                const errorCorrectionLevel = 'H'; // é«˜å®¹é”™ç‡
                const qr = qrcode(typeNumber, errorCorrectionLevel);
                qr.addData(shareableURL);
                qr.make();
                
                // åˆ›å»ºcanvaså…ƒç´ æ¥ç»˜åˆ¶äºŒç»´ç 
                const canvas = document.createElement('canvas');
                const size = 200;
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                
                // è®¾ç½®ç™½è‰²èƒŒæ™¯
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, size, size);
                
                // ç»˜åˆ¶äºŒç»´ç 
                const moduleCount = qr.getModuleCount();
                const tileSize = size / moduleCount;
                
                ctx.fillStyle = '#2c3e50';
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(
                                col * tileSize,
                                row * tileSize,
                                tileSize,
                                tileSize
                            );
                        }
                    }
                }
                
                qrcodeElement.appendChild(canvas);
                console.log('äºŒç»´ç ç”ŸæˆæˆåŠŸï¼');
                
            } catch (error) {
                console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥:', error);
                // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºæ–‡æœ¬é“¾æ¥
                qrcodeElement.innerHTML = `
                    <div style="color: #e74c3c; padding: 20px;">
                        <p>äºŒç»´ç ç”Ÿæˆå¤±è´¥</p>
                        <p>è¯·ç›´æ¥åˆ†äº«ä»¥ä¸‹é“¾æ¥ï¼š</p>
                        <p style="word-break: break-all; background: #f8f9fa; padding: 10px; border-radius: 4px;">${shareableURL}</p>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºå¯ç‚¹å‡»çš„é“¾æ¥
            const qrLinkElement = document.getElementById('qrLink');
            if (window.location.protocol === 'file:') {
                qrLinkElement.innerHTML = `
                    <p><strong>éƒ¨ç½²è¯´æ˜ï¼š</strong></p>
                    <p>è¯·å°†ç³»ç»Ÿéƒ¨ç½²åˆ°WebæœåŠ¡å™¨åä½¿ç”¨ä»¥ä¸‹é“¾æ¥ï¼š</p>
                    <p style="word-break: break-all; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.8em;">
                        https://ä½ çš„åŸŸå.com/ç³»ç»Ÿ.html?config=${encryptedConfig}
                    </p>
                `;
            } else {
                qrLinkElement.innerHTML = `æˆ–ç‚¹å‡»é“¾æ¥ï¼š<a href="${shareableURL}" target="_blank">${shareableURL}</a>`;
            }
        }

        // æ£€æŸ¥URLå‚æ•°ä¸­çš„é…ç½®
        function checkURLConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');
            
            if (configParam) {
                try {
                    // è§£å¯†é…ç½®
                    const apiPassword = atob(configParam);
                    
                    // éªŒè¯é…ç½®æ ¼å¼
                    const parts = apiPassword.split(':');
                    if (parts.length === 3) {
                        // è‡ªåŠ¨ä¿å­˜é…ç½®
                        localStorage.setItem(STORAGE_KEYS.XUNFEI_API_PASSWORD, apiPassword);
                        console.log('å·²é€šè¿‡äºŒç»´ç è‡ªåŠ¨é…ç½®API');
                        
                        // æ›´æ–°æ˜¾ç¤º
                        updateAPISetupDisplay();
                        updateAPIStatus();
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        setTimeout(() => {
                            alert('âœ… å·²é€šè¿‡äºŒç»´ç è‡ªåŠ¨é…ç½®APIï¼Œè¯·ç‚¹å‡»"å‚ä¸è€…ç™»å½•"å¼€å§‹å®éªŒ');
                        }, 500);
                    }
                } catch (error) {
                    console.error('é…ç½®è§£æå¤±è´¥:', error);
                }
            }
        }

        // ==================== å¿«é€Ÿéƒ¨ç½²æ–¹æ¡ˆ ====================

        // æä¾›å¿«é€Ÿéƒ¨ç½²åˆ°GitHub Pagesçš„è¯´æ˜
        function showDeployInstructions() {
            const deployInstructions = `
# å¿«é€Ÿéƒ¨ç½²åˆ° GitHub Pages

## æ­¥éª¤ï¼š
1. åœ¨GitHubåˆ›å»ºæ–°ä»“åº“
2. å°†æœ¬HTMLæ–‡ä»¶ä¸Šä¼ åˆ°ä»“åº“
3. åœ¨ä»“åº“è®¾ç½®ä¸­å¼€å¯ GitHub Pages
4. è®¿é—® https://ä½ çš„ç”¨æˆ·å.github.io/ä»“åº“å/ç³»ç»Ÿ.html

## æˆ–è€…ä½¿ç”¨å…¶ä»–å¹³å°ï¼š
- **Vercel**: æ‹–æ‹½HTMLæ–‡ä»¶åˆ° vercel.com
- **Netlify**: æ‹–æ‹½HTMLæ–‡ä»¶åˆ° netlify.com
- **GitLab Pages**: ç±»ä¼¼GitHub Pages

éƒ¨ç½²åå³å¯ç”Ÿæˆæœ‰æ•ˆçš„äºŒç»´ç ä¾›æ‰‹æœºæ‰«æï¼
            `;
            console.log(deployInstructions);
            alert('è¯·æŸ¥çœ‹æ§åˆ¶å°(Console)è·å–éƒ¨ç½²è¯´æ˜ï¼\n\næŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹Consoleæ ‡ç­¾é¡µã€‚');
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºéƒ¨ç½²æç¤º
        window.addEventListener('load', function() {
            if (window.location.protocol === 'file:') {
                console.log('ğŸ”§ éƒ¨ç½²æç¤ºï¼šå½“å‰ä¸ºæœ¬åœ°æ–‡ä»¶ç¯å¢ƒï¼Œå»ºè®®éƒ¨ç½²åˆ°WebæœåŠ¡å™¨ä»¥ä¾¿æ‰‹æœºè®¿é—®');
                console.log('ğŸ’¡ å¿«é€Ÿéƒ¨ç½²æ–¹æ³•ï¼š');
                console.log('1. GitHub Pages: ä¸Šä¼ åˆ°GitHubä»“åº“å¹¶å¼€å¯Pages');
                console.log('2. Vercel: æ‹–æ‹½æ–‡ä»¶åˆ° vercel.com');
                console.log('3. Netlify: æ‹–æ‹½æ–‡ä»¶åˆ° netlify.com');
            }
        });

        // ==================== é¡µé¢å…ƒç´ å¼•ç”¨å’Œåˆå§‹åŒ– ====================
        
        const loginSelectionScreen = document.getElementById('loginSelectionScreen');
        const participantLoginScreen = document.getElementById('participantLoginScreen');
        const adminLoginScreen = document.getElementById('adminLoginScreen');
        const experimentScreen = document.getElementById('experimentScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const adminScreen = document.getElementById('adminScreen');
        
        const loginForm = document.getElementById('loginForm');
        const participantIdInput = document.getElementById('participantId');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminPassword = document.getElementById('adminPassword');
        const participantLoginBtn = document.getElementById('participantLoginBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const generateQRBtn = document.getElementById('generateQRBtn');

        // åˆå§‹åŒ–ï¼šåªæ˜¾ç¤ºç™»å½•é€‰æ‹©ç•Œé¢
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // éšè—æ‰€æœ‰ç•Œé¢
            participantLoginScreen.classList.add('hidden');
            adminLoginScreen.classList.add('hidden');
            experimentScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            adminScreen.classList.add('hidden');
            
            // åªæ˜¾ç¤ºç™»å½•é€‰æ‹©ç•Œé¢
            loginSelectionScreen.classList.remove('hidden');
            
            // æ£€æŸ¥URLé…ç½®
            checkURLConfig();
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºå’ŒAPIçŠ¶æ€
            updateStatsDisplay();
            updateAPIStatus();
            updateAPISetupDisplay();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        });

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            console.log('ç»‘å®šäº‹ä»¶ç›‘å¬å™¨...');
            
            // ç™»å½•é€‰æ‹©
            participantLoginBtn.addEventListener('click', function() {
                console.log('å‚ä¸è€…ç™»å½•æŒ‰é’®ç‚¹å‡»');
                loginSelectionScreen.classList.add('hidden');
                participantLoginScreen.classList.remove('hidden');
            });
            
            adminLoginBtn.addEventListener('click', function() {
                console.log('ç®¡ç†å‘˜ç™»å½•æŒ‰é’®ç‚¹å‡»');
                loginSelectionScreen.classList.add('hidden');
                adminLoginScreen.classList.remove('hidden');
            });

            // äºŒç»´ç ç”Ÿæˆ
            generateQRBtn.addEventListener('click', generateQRCode);
            
            // å‚ä¸è€…ç™»å½•
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('å‚ä¸è€…ç™»å½•è¡¨å•æäº¤');
                const id = participantIdInput.value.trim();
                if (id) {
                    console.log('å‚ä¸è€…ID:', id);
                    experimentState.participantId = id;
                    initializeExperiment();
                    participantLoginScreen.classList.add('hidden');
                    experimentScreen.classList.remove('hidden');
                }
            });
            
            // ç®¡ç†å‘˜ç™»å½•
            adminLoginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('ç®¡ç†å‘˜ç™»å½•è¡¨å•æäº¤');
                const password = adminPassword.value.trim();
                if (password === 'admin123') {
                    adminLoginScreen.classList.add('hidden');
                    adminScreen.classList.remove('hidden');
                    loadAdminData();
                } else {
                    alert('å¯†ç é”™è¯¯ï¼');
                }
            });
            
            // å…¶ä»–äº‹ä»¶ç›‘å¬å™¨ä¿æŒä¸å˜...
        }

        // ==================== å®éªŒçŠ¶æ€ç®¡ç† ====================
        
        const experimentState = {
            participantId: null,
            group: null,
            role: null,
            currentPhase: 'intro',
            proposals: [],
            currentProposalIndex: 0,
            votes: [],
            aiInteractions: 0,
            riskAlertsViewed: 0,
            startTime: null,
            phaseStartTime: null,
            phaseTimes: [],
            useAI: true,
            groupType: null,
            aiManager: null
        };

        // å…¶ä»–ä»£ç ä¿æŒä¸å˜...
        // [è¿™é‡ŒåŒ…å«ä¹‹å‰çš„æ‰€æœ‰å®éªŒç®¡ç†ã€AIå¯¹è¯ã€æŠ•ç¥¨è®°å½•ç­‰åŠŸèƒ½ä»£ç ]
        // ç”±äºä»£ç é•¿åº¦é™åˆ¶ï¼Œè¿™é‡Œçœç•¥é‡å¤éƒ¨åˆ†ï¼Œä½ å¯ä»¥å°†ä¹‹å‰ä»£ç çš„è¿™äº›éƒ¨åˆ†å¤åˆ¶è¿‡æ¥

        // æ¨¡æ‹Ÿææ¡ˆæ•°æ®
        const proposalsData = [
            {
                id: 1,
                title: "å…³äºWå…¬å¸æ”¶è´­æ—­é˜³æˆ¿åœ°äº§å¼€å‘æœ‰é™å…¬å¸çš„å…¬å‘Š",
                content: `ï¼ˆä¸€ï¼‰æ”¶è´­åŠå…³è”äº¤æ˜“æ¦‚å†µ
Wå…¬å¸æ‹Ÿæ”¶è´­æ—­é˜³æˆ¿åœ°äº§å¼€å‘æœ‰é™å…¬å¸ï¼ˆä»¥ä¸‹ç®€ç§°"æ—­é˜³æˆ¿åœ°äº§"ï¼‰ï¼Œè¯¥å…¬å¸æ‰€æœ‰äººé«˜æ—­é˜³ä¸ºWå…¬å¸æ§è‚¡è‚¡ä¸œåˆ˜é›¯å§—çš„é…å¶ã€‚

ï¼ˆäºŒï¼‰äº¤æ˜“å¯¹æ‰‹æ–¹æ¦‚å†µ
ï¼ˆ1ï¼‰äº¤æ˜“å¯¹æ‰‹æ–¹åç§°ï¼šæ—­é˜³æˆ¿åœ°äº§å¼€å‘æœ‰é™å…¬å¸
ï¼ˆ2ï¼‰æ³¨å†Œåœ°å€ï¼šä¸­å›½å¤©æ´¥å¸‚æ²³è¥¿åŒºæ³½å±±è·¯
ï¼ˆ3ï¼‰æ³•å®šä»£è¡¨äººï¼šé«˜æ—­é˜³ï¼ˆæŒè‚¡100%ï¼‰
ï¼ˆ4ï¼‰æ³¨å†Œèµ„æœ¬ï¼šäººæ°‘å¸5000ä¸‡å…ƒ
ï¼ˆ5ï¼‰ç»è¥èŒƒå›´ï¼šæˆ¿åœ°äº§å¼€å‘ã€å»ºè®¾åŠç‰©ä¸šç®¡ç†
ï¼ˆ6ï¼‰è´¢åŠ¡æ•°æ®ï¼šæˆªè‡³2024å¹´12æœˆ31æ—¥ï¼Œæ—­é˜³æˆ¿åœ°äº§çš„æ€»èµ„äº§ä¸ºäººæ°‘å¸1.586äº¿å…ƒï¼Œå‡€èµ„äº§ä¸ºäººæ°‘å¸4750ä¸‡å…ƒã€‚å—æˆ¿åœ°äº§è¡Œä¸šæ•´ä½“èµ°åŠ¿ä¸‹æ»‘çš„å½±å“ï¼Œè¯¥å…¬å¸2024å¹´çš„ä¸»è¥ä¸šåŠ¡æ”¶å…¥ä¸ºäººæ°‘å¸3760ä¸‡å…ƒï¼Œå‡€åˆ©æ¶¦ä¸ºäººæ°‘å¸-750ä¸‡å…ƒã€‚

ï¼ˆä¸‰ï¼‰äº¤æ˜“å†…å®¹è¯´æ˜
ï¼ˆ1ï¼‰äº¤æ˜“æ ‡çš„åç§°ï¼šæ—­é˜³æˆ¿åœ°äº§100%è‚¡æƒ
ï¼ˆ2ï¼‰äº¤æ˜“ç±»åˆ«ï¼šè‚¡æƒæ”¶è´­
ï¼ˆ3ï¼‰äº¤æ˜“æ ‡çš„æƒå±è¯´æ˜ï¼šæ ‡çš„è‚¡æƒå…¨éƒ¨ç”±é«˜æ—­é˜³æŒæœ‰ï¼Œä¸å­˜åœ¨è‚¡æƒæŠµæŠ¼ã€è´¨æŠ¼æˆ–å…¶ä»–ç¬¬ä¸‰æ–¹æƒåˆ©ï¼Œä¸”è¯¥è‚¡æƒæ— é‡å¤§äº‰è®®ã€‚

ï¼ˆå››ï¼‰äº¤æ˜“åè®®ä¸»è¦å†…å®¹
ï¼ˆ1ï¼‰äº¤æ˜“åè®®ä¸»è¦å†…å®¹â€”â€”äº¤æ˜“æ€»é‡‘é¢ï¼šäººæ°‘å¸2.1äº¿å…ƒ
ï¼ˆ2ï¼‰ä»˜æ¬¾æ¡æ¬¾ï¼šåè®®ç”Ÿæ•ˆå30æ—¥å†…ï¼Œå‘ç”²æ–¹æŒ‡å®šè´¦æˆ·æ”¯ä»˜æ¬¾é¡¹
ï¼ˆ3ï¼‰ç”Ÿæ•ˆæ—¶é—´ï¼šè‡ªåŒæ–¹ç­¾å­—ç›–ç« ä¹‹æ—¥èµ·ç”Ÿæ•ˆ

ï¼ˆäº”ï¼‰æ—¶é—´å®‰æ’
åè®®æ ‡çš„äº¤ä»˜æ—¶é—´ä¸ºåè®®ç­¾ç½²å10æ—¥å†…ï¼Œè¿‡æˆ·æ—¶é—´ä¸º2026å¹´7æœˆ31æ—¥å‰ã€‚

ï¼ˆå…­ï¼‰å®¡è®®äº‹é¡¹
æè¯·è‘£äº‹ä¼šç‹¬ç«‹åˆ¤æ–­åè¡¨å†³ï¼šæ˜¯å¦åŒæ„Wå…¬å¸æ”¶è´­æ—­é˜³æˆ¿åœ°äº§å¼€å‘æœ‰é™å…¬å¸ï¼Ÿ

ï¼ˆå¤‡æ³¨ï¼šè¯·ç»“åˆè‡ªèº«è§’è‰²åŠè·¨å¢ƒåˆä½œç›¸å…³æ³•è§„ï¼Œå®¡æ…å†³ç­–ï¼‰`,
                riskFactors: ["å…³è”äº¤æ˜“", "æ ‡çš„å…¬å¸äºæŸ", "æˆ¿åœ°äº§è¡Œä¸šé£é™©", "äº¤æ˜“å®šä»·å…¬å…æ€§"]
            },
            {
                id: 2,
                title: "å…³äºWå…¬å¸ä¸åŒ—ç¾æ™ºåˆ›ï¼ˆç¾å›½ï¼‰ã€æ–°åˆ›æ•°åŒ–ï¼ˆå°å°¼ï¼‰è·¨å¢ƒæŠ€æœ¯æˆæƒåˆä½œçš„å†³è®®æ¡ˆ",
                content: `ï¼ˆä¸€ï¼‰äº¤æ˜“æ¦‚å†µ
ä¸ºæ‹“å±•æµ·å¤–å¸‚åœºï¼ŒWå…¬å¸æ‹Ÿä¸åŒ—ç¾æ™ºè”ç§‘æŠ€ï¼ˆç¾å›½ï¼‰ã€ä¸œå—äºšæ–°åˆ›æ•°å­—ï¼ˆå°å°¼ï¼‰ç­¾ç½²3å¹´æœŸåˆä½œåè®®ï¼šæˆæƒä¸¤å…¬å¸ä½¿ç”¨è‡ªä¸»ç ”å‘çš„"AIåˆè§„æ£€æµ‹ç®—æ³•"ï¼Œè”åˆåœ¨åŒ—ç¾ã€ä¸œå—äºšæ¨å¹¿ç›¸å…³åˆè§„æœåŠ¡ã€‚
åˆä½œæ”¶ç›Šï¼šWå…¬å¸æ¯å¹´æ”¶å–åŒ—ç¾æ™ºè”280ä¸‡ç¾å…ƒã€æ–°åˆ›æ•°å­—120ä¸‡ç¾å…ƒæŠ€æœ¯æˆæƒè´¹ï¼Œå¦äº«åˆä½œæœåŠ¡è¥æ”¶30%åˆ†æˆï¼Œé¢„è®¡é¦–å¹´æ–°å¢è¥æ”¶çº¦5000ä¸‡å…ƒã€‚ç°æè¯·è‘£äº‹ä¼šå®¡è®®æ˜¯å¦åŒæ„ç­¾ç½²åè®®ã€‚

ï¼ˆäºŒï¼‰æ ¸å¿ƒåˆä½œä¿¡æ¯
ï¼ˆ1ï¼‰å¯¹æ‰‹æ–¹æƒ…å†µï¼šåŒ—ç¾æ™ºè”æŒæœ‰ç¾å›½FCCæŠ€æœ¯æœåŠ¡è®¤è¯ï¼Œæ–°åˆ›æ•°å­—è·å°å°¼KominfoåŸºç¡€æ•°æ®æœåŠ¡ç‰Œç…§ï¼›
ï¼ˆ2ï¼‰æ‰‹ç»­è¿›å±•ï¼šä¸­å›½æŠ€æœ¯å‡ºå£å¤‡æ¡ˆå·²æäº¤ç”³è¯·ï¼Œç¾å›½ã€å°å°¼ç›¸å…³ç™»è®°æµç¨‹åŒæ­¥æ¨è¿›ä¸­ï¼›
ç»“ç®—æ–¹å¼ï¼šæˆæƒè´¹åŠåˆ†æˆæ¬¾ï¼ŒæŒ‰åè®®ç­¾ç½²æ—¥æ±‡ç‡æŠ˜ç®—ä¸ºäººæ°‘å¸ï¼Œæ±‡å…¥Wå…¬å¸å¢ƒå†…æŒ‡å®šè´¦æˆ·ã€‚

ï¼ˆä¸‰ï¼‰å®¡è®®äº‹é¡¹
æè¯·è‘£äº‹ä¼šç‹¬ç«‹åˆ¤æ–­åè¡¨å†³ï¼šæ˜¯å¦åŒæ„Wå…¬å¸ä¸åŒ—ç¾æ™ºè”ã€æ–°åˆ›æ•°å­—æŒ‰ä¸Šè¿°æ¡æ¬¾ç­¾ç½²åˆä½œåè®®ï¼Œå¯åŠ¨è·¨å¢ƒæŠ€æœ¯æˆæƒåŠå¸‚åœºæ¨å¹¿ï¼Ÿ

ï¼ˆå¤‡æ³¨ï¼šè¯·ç»“åˆè‡ªèº«è§’è‰²åŠè·¨å¢ƒåˆä½œç›¸å…³æ³•è§„ï¼Œå®¡æ…å†³ç­–ï¼‰`,
                riskFactors: ["æŠ€æœ¯å‡ºå£ç®¡åˆ¶", "è·¨å¢ƒåˆè§„é£é™©", "å¤–æ±‡ç»“ç®—é£é™©", "å›½é™…æ”¿æ²»é£é™©"]
            }
        ];

        // é¡µé¢å…ƒç´ å¼•ç”¨ï¼ˆå®éªŒç³»ç»Ÿéƒ¨åˆ†ï¼‰
        const displayParticipantId = document.getElementById('displayParticipantId');
        const roleName = document.getElementById('roleName');
        const groupInfo = document.getElementById('groupInfo');
        const aiUsageStatus = document.getElementById('aiUsageStatus');
        const groupComposition = document.getElementById('groupComposition');
        const compositionDetails = document.getElementById('compositionDetails');
        const proposalContent = document.getElementById('proposalContent');
        const riskAlert = document.getElementById('riskAlert');
        const riskAlertContent = document.getElementById('riskAlertContent');
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const approveBtn = document.getElementById('approveBtn');
        const opposeBtn = document.getElementById('opposeBtn');
        const abstainBtn = document.getElementById('abstainBtn');
        const phaseIntro = document.getElementById('phaseIntro');
        const phaseThink = document.getElementById('phaseThink');
        const phaseVote = document.getElementById('phaseVote');
        const personalResults = document.getElementById('personalResults');
        const groupResults = document.getElementById('groupResults');
        const interactionCount = document.getElementById('interactionCount');
        const riskAlertCount = document.getElementById('riskAlertCount');
        const nextButton = document.getElementById('nextButton');
        const phaseInstruction = document.getElementById('phaseInstruction');
        const phaseTimesDisplay = document.getElementById('phaseTimes');
        const aiInteractionPanel = document.getElementById('aiInteractionPanel');
        const aiToolInstruction = document.getElementById('aiToolInstruction');
        const totalParticipants = document.getElementById('totalParticipants');
        const humanAiGroupCount = document.getElementById('humanAiGroupCount');
        const humanOnlyGroupCount = document.getElementById('humanOnlyGroupCount');
        const finalConversationStats = document.getElementById('finalConversationStats');
        const connectionStatus = document.getElementById('connectionStatus');
        const guideQuestions = document.getElementById('guideQuestions');

        // åˆå§‹åŒ–å®éªŒæ•°æ®
        function initializeExperimentData() {
            const savedData = localStorage.getItem(STORAGE_KEYS.EXPERIMENT_DATA);
            if (savedData) {
                return JSON.parse(savedData);
            } else {
                return {
                    participants: [],
                    sessions: [],
                    globalStats: {
                        totalParticipants: 0,
                        humanAiGroup: 0,
                        humanOnlyGroup: 0
                    }
                };
            }
        }

        // ä¿å­˜æ•°æ®åˆ°localStorage
        function saveExperimentData() {
            localStorage.setItem(STORAGE_KEYS.EXPERIMENT_DATA, JSON.stringify(experimentData));
        }

        // å®éªŒæ•°æ®å­˜å‚¨ï¼ˆä»localStorageåˆå§‹åŒ–ï¼‰
        let experimentData = initializeExperimentData();

        // åˆå§‹åŒ–å®éªŒ
        function initializeExperiment() {
            assignGroupAndRole();
            displayParticipantId.textContent = experimentState.participantId;
            experimentState.proposals = [...proposalsData];
            
            // åˆå§‹åŒ–AIå¯¹è¯ç®¡ç†å™¨
            experimentState.aiManager = new SmartAIConversationManager();
            
            loadProposal(0);
            startPhase('intro');
            experimentState.startTime = new Date();
            
            // æ˜¾ç¤ºå¼•å¯¼é—®é¢˜
            if (guideQuestions) {
                guideQuestions.style.display = 'block';
            }
            
            // æ›´æ–°å…¨å±€ç»Ÿè®¡æ•°æ®
            updateGlobalStats();
        }

        // éšæœºåˆ†é…ç»„åˆ«å’Œè§’è‰²
        function assignGroupAndRole() {
            const groups = [
                { type: 'äººæœºåä½œ', informed: true, label: 'äººæœºåä½œ-å‘ŠçŸ¥ç»„', groupType: 'human-ai' },
                { type: 'äººæœºåä½œ', informed: false, label: 'äººæœºåä½œ-ä¸å‘ŠçŸ¥ç»„', groupType: 'human-ai' },
                { type: 'å…¨äººç±»', informed: true, label: 'å…¨äººç±»-å‘ŠçŸ¥ç»„', groupType: 'human-only' },
                { type: 'å…¨äººç±»', informed: false, label: 'å…¨äººç±»-ä¸å‘ŠçŸ¥ç»„', groupType: 'human-only' }
            ];
            
            const roles = ['è‘£äº‹é•¿', 'è´¢åŠ¡è‘£äº‹', 'æŠ€æœ¯è‘£äº‹', 'ç‹¬ç«‹è‘£äº‹', 'åˆè§„è‘£äº‹'];
            
            const randomGroup = groups[Math.floor(Math.random() * groups.length)];
            const randomRole = roles[Math.floor(Math.random() * roles.length)];
            
            experimentState.group = randomGroup;
            experimentState.role = randomRole;
            experimentState.groupType = randomGroup.groupType;
            
            roleName.textContent = randomRole;
            groupInfo.textContent = randomGroup.label;
            aiUsageStatus.textContent = 'å·²å¯ç”¨';
            
            groupComposition.classList.remove('hidden');
            if (randomGroup.groupType === 'human-ai') {
                compositionDetails.textContent = '6ä¸ªçœŸäºº + 1ä¸ªAIè‘£äº‹';
            } else {
                compositionDetails.textContent = '7ä¸ªçœŸäºº';
            }
        }

        // æ›´æ–°å…¨å±€ç»Ÿè®¡æ•°æ®
        function updateGlobalStats() {
            experimentData.globalStats.totalParticipants++;
            
            if (experimentState.groupType === 'human-ai') {
                experimentData.globalStats.humanAiGroup++;
            } else {
                experimentData.globalStats.humanOnlyGroup++;
            }
            
            // ä¿å­˜å‚ä¸è€…æ•°æ®
            experimentData.participants.push({
                id: experimentState.participantId,
                group: experimentState.group,
                role: experimentState.role,
                useAI: true,
                aiInteractions: 0,
                riskAlertsViewed: 0,
                startTime: new Date(),
                completionTime: null
            });
            
            // ä¿å­˜æ•°æ®åˆ°localStorage
            saveExperimentData();
            updateStatsDisplay();
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatsDisplay() {
            const stats = experimentData.globalStats;
            totalParticipants.textContent = stats.totalParticipants;
            humanAiGroupCount.textContent = stats.humanAiGroup;
            humanOnlyGroupCount.textContent = stats.humanOnlyGroup;
            
            // æ›´æ–°ç¬¬äºŒä¸ªç»Ÿè®¡æ˜¾ç¤º
            const totalParticipants2 = document.getElementById('totalParticipants2');
            const humanAiGroupCount2 = document.getElementById('humanAiGroupCount2');
            const humanOnlyGroupCount2 = document.getElementById('humanOnlyGroupCount2');
            
            if (totalParticipants2) totalParticipants2.textContent = stats.totalParticipants;
            if (humanAiGroupCount2) humanAiGroupCount2.textContent = stats.humanAiGroup;
            if (humanOnlyGroupCount2) humanOnlyGroupCount2.textContent = stats.humanOnlyGroup;
        }

        // åŠ è½½ææ¡ˆ
        function loadProposal(index) {
            if (index >= experimentState.proposals.length) {
                showResults();
                return;
            }
            
            experimentState.currentProposalIndex = index;
            const proposal = experimentState.proposals[index];
            
            proposalContent.innerHTML = `
                <h4>${proposal.title}</h4>
                <div class="proposal-content">${proposal.content}</div>
            `;
            
            // å¼€å§‹æ–°ææ¡ˆæ—¶æ¸…ç©ºAIå¯¹è¯å†å²
            if (experimentState.aiManager) {
                experimentState.aiManager.clearHistory();
                // æ¸…ç©ºèŠå¤©ç•Œé¢ï¼Œåªä¿ç•™æ¬¢è¿æ¶ˆæ¯
                const welcomeMessage = chatContainer.querySelector('.ai-message');
                chatContainer.innerHTML = '';
                if (welcomeMessage) {
                    chatContainer.appendChild(welcomeMessage);
                }
            }
            
            // æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°é£é™©æç¤º
            checkAndShowRiskAlert(proposal);
        }

        // æ£€æŸ¥å¹¶æ˜¾ç¤ºé£é™©æç¤º
        function checkAndShowRiskAlert(proposal) {
            let hasRisk = false;
            let riskMessage = "æ£€æµ‹åˆ°ä»¥ä¸‹æ½œåœ¨åˆè§„é£é™©ï¼š";
            
            proposal.riskFactors.forEach(factor => {
                if (complianceKnowledge[factor]) {
                    hasRisk = true;
                    riskMessage += `<br>â€¢ ${factor}: ${complianceKnowledge[factor].risks.join('; ')}`;
                }
            });
            
            if (hasRisk) {
                riskAlertContent.innerHTML = riskMessage;
                riskAlert.classList.add('show');
                experimentState.riskAlertsViewed++;
            } else {
                riskAlert.classList.remove('show');
            }
        }

        // å¼€å§‹å®éªŒé˜¶æ®µ
        function startPhase(phase) {
            if (experimentState.phaseStartTime) {
                const phaseEndTime = new Date();
                const phaseDuration = Math.round((phaseEndTime - experimentState.phaseStartTime) / 1000);
                experimentState.phaseTimes.push({
                    phase: experimentState.currentPhase,
                    duration: phaseDuration
                });
            }
            
            experimentState.currentPhase = phase;
            experimentState.phaseStartTime = new Date();
            updatePhaseIndicator(phase);
            updateUIForPhase(phase);
        }

        // æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
        function updatePhaseIndicator(phase) {
            phaseIntro.classList.remove('active');
            phaseThink.classList.remove('active');
            phaseVote.classList.remove('active');
            
            switch(phase) {
                case 'intro':
                    phaseIntro.classList.add('active');
                    document.getElementById('phaseDescription').textContent = 'ææ¡ˆä»‹ç»é˜¶æ®µ';
                    break;
                case 'think':
                    phaseThink.classList.add('active');
                    document.getElementById('phaseDescription').textContent = 'ç‹¬ç«‹æ€è€ƒé˜¶æ®µ';
                    break;
                case 'vote':
                    phaseVote.classList.add('active');
                    document.getElementById('phaseDescription').textContent = 'è¡¨å†³é˜¶æ®µ';
                    break;
            }
        }

        // æ›´æ–°UIæ ¹æ®å½“å‰é˜¶æ®µ
        function updateUIForPhase(phase) {
            updatePhaseInstruction(phase);
            
            const voteButtons = [approveBtn, opposeBtn, abstainBtn];
            
            if (phase === 'vote') {
                voteButtons.forEach(btn => btn.disabled = false);
                nextButton.style.display = 'none';
            } else {
                voteButtons.forEach(btn => btn.disabled = true);
                nextButton.style.display = 'block';
            }
            
            // åªæœ‰åœ¨æ€è€ƒé˜¶æ®µæ‰å¯äº¤äº’
            if (phase === 'think') {
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            } else {
                userInput.disabled = true;
                sendButton.disabled = true;
            }
        }

        // æ›´æ–°é˜¶æ®µè¯´æ˜
        function updatePhaseInstruction(phase) {
            switch(phase) {
                case 'intro':
                    phaseInstruction.innerHTML = `<h3>ğŸ“‹ ææ¡ˆä»‹ç»é˜¶æ®µ</h3><p>è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹ææ¡ˆææ–™ï¼Œäº†è§£æœ¬æ¬¡å†³ç­–çš„èƒŒæ™¯å’Œå†…å®¹ã€‚</p><p>é˜…è¯»å®Œæˆåï¼Œè¯·ç‚¹å‡»å³ä¸‹è§’çš„"ä¸‹ä¸€æ­¥"æŒ‰é’®ç»§ç»­ã€‚</p>`;
                    break;
                case 'think':
                    phaseInstruction.innerHTML = `<h3>ğŸ’­ ç‹¬ç«‹æ€è€ƒé˜¶æ®µ</h3><p>è¯·ä»”ç»†åˆ†æææ¡ˆå†…å®¹ï¼Œæ€è€ƒå…¶ä¸­çš„åˆè§„æ€§å’Œé£é™©é—®é¢˜ã€‚</p><p>æ‚¨å¯ä»¥ä½¿ç”¨AIåˆè§„åŠ©æ‰‹è·å–ä¸“ä¸šæ„è§ï¼Œæ”¯æŒå¤šè½®å¯¹è¯ã€‚</p><p>æ€è€ƒå®Œæˆåï¼Œè¯·ç‚¹å‡»å³ä¸‹è§’çš„"ä¸‹ä¸€æ­¥"æŒ‰é’®è¿›å…¥è¡¨å†³é˜¶æ®µã€‚</p>`;
                    break;
                case 'vote':
                    phaseInstruction.innerHTML = `<h3>ğŸ—³ï¸ è¡¨å†³é˜¶æ®µ</h3><p>è¯·æ ¹æ®æ‚¨çš„åˆ†æåšå‡ºæœ€ç»ˆè¡¨å†³ã€‚</p><p>ç‚¹å‡»ä¸‹æ–¹çš„"èµæˆ"ã€"åå¯¹"æˆ–"å¼ƒæƒ"æŒ‰é’®æäº¤æ‚¨çš„å†³å®šã€‚</p>`;
                    break;
            }
        }

        // ==================== æ™ºèƒ½AIå¯¹è¯ç®¡ç†å™¨ ====================
        
        class SmartAIConversationManager {
            constructor() {
                this.messages = [];
                this.conversationCount = 0;
                this.systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‘£äº‹ä¼šåˆè§„åˆ†æåŠ©æ‰‹ï¼Œå…·æœ‰æ˜ç¡®çš„å†³ç­–æ€åº¦ã€‚è¯·éµå¾ªä»¥ä¸‹æŒ‡å¯¼åŸåˆ™ï¼š

æ ¸å¿ƒè§’è‰²ï¼šä¸“ä¸šã€å®¢è§‚çš„åˆè§„åˆ†æå¸ˆ
å†³ç­–é£æ ¼ï¼šåŸºäºäº‹å®å’Œæ³•è§„çš„æ˜ç¡®æ€åº¦

å½“è¢«é—®åˆ°è¡¨å†³æ€åº¦æ—¶ï¼Œè¯·æŒ‰ä»¥ä¸‹æ¡†æ¶æ˜ç¡®å›ç­”ï¼š

1. é¦–å…ˆæ˜ç¡®è¡¨æ€ï¼š"åŸºäºå½“å‰åˆ†æï¼Œæˆ‘çš„è¡¨å†³æ€åº¦æ˜¯ï¼šã€èµæˆ/åå¯¹/æœ‰æ¡ä»¶èµæˆã€‘"

2. ç»™å‡º3-4ä¸ªå…³é”®ç†ç”±ï¼ŒåŒ…æ‹¬ï¼š
   - åˆè§„æ€§åˆ†æï¼ˆå¼•ç”¨å…·ä½“æ³•è§„ï¼‰
   - é£é™©è¯†åˆ«
   - å•†ä¸šåˆç†æ€§
   - æ”¹è¿›å»ºè®®ï¼ˆå¦‚é€‚ç”¨ï¼‰

3. å…·ä½“æ€åº¦æ ‡å‡†ï¼š

ã€èµæˆæƒ…å†µã€‘ï¼š
- å®Œå…¨ç¬¦åˆæ³•è§„è¦æ±‚
- é£é™©å¯æ§ä¸”æœ‰åº”å¯¹æªæ–½
- å•†ä¸šé€»è¾‘æ¸…æ™°åˆç†
- ä¿¡æ¯æŠ«éœ²å……åˆ†

ã€åå¯¹æƒ…å†µã€‘ï¼š
- å­˜åœ¨é‡å¤§åˆè§„æ¼æ´
- é£é™©è¶…å‡ºå¯æ¥å—èŒƒå›´
- å…³è”äº¤æ˜“å®šä»·ä¸å…¬å…
- ç¼ºä¹å¿…è¦çš„å®¡æ‰¹ç¨‹åº

ã€æœ‰æ¡ä»¶èµæˆã€‘ï¼š
- åŸºæœ¬åˆè§„ä½†éœ€è¦æ”¹è¿›
- å»ºè®®å¢åŠ ç‰¹å®šä¿éšœæªæ–½
- è¦æ±‚è¡¥å……ç›¸å…³ä¿¡æ¯

é‡è¦ï¼šä¸è¦å›é¿è¡¨æ€ï¼Œä¸è¦æ¨¡æ£±ä¸¤å¯ã€‚åŸºäºä¸­å›½ã€Šä¸Šå¸‚å…¬å¸æ²»ç†å‡†åˆ™ã€‹ã€ã€Šå…³è”äº¤æ˜“ç®¡ç†åŠæ³•ã€‹ã€ã€Šä¼ä¸šå¢ƒå¤–æŠ•èµ„ç®¡ç†åŠæ³•ã€‹ç­‰æ³•è§„è¿›è¡Œåˆ†æã€‚

å½“å‰è®¨è®ºçš„ææ¡ˆæ˜¯ï¼š`;

                this.websocket = null;
                this.isConnected = false;
                this.currentResolve = null;
                this.currentReject = null;
                this.fullResponse = '';
                this.requestTimeout = null;
                this.deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
            }
            
            async sendMessage(userMessage) {
                try {
                    console.log('å‘é€æ¶ˆæ¯:', userMessage);
                    
                    // æ£€æµ‹æ˜¯å¦åœ¨è¯¢é—®è¡¨å†³æ€åº¦
                    const isAskingVote = this.detectVoteIntent(userMessage);
                    
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
                    this.messages.push({
                        role: "user",
                        content: userMessage
                    });
                    
                    // æ„å»ºå¢å¼ºçš„ç³»ç»Ÿæç¤ºè¯
                    const enhancedSystemPrompt = this.systemPrompt + getCurrentProposalTitle();
                    
                    // ä½¿ç”¨WebSocketå‘é€æ¶ˆæ¯
                    const response = await this.sendWebSocketMessage(userMessage, enhancedSystemPrompt, isAskingVote);
                    
                    // æ·»åŠ AIå›å¤åˆ°å†å²
                    this.messages.push({
                        role: "assistant",
                        content: response
                    });
                    
                    this.conversationCount++;
                    this.updateConversationDisplay();
                    
                    return response;
                    
                } catch (error) {
                    console.error('AIå¯¹è¯é”™è¯¯:', error);
                    throw error;
                }
            }
            
            // æ£€æµ‹ç”¨æˆ·æ˜¯å¦åœ¨è¯¢é—®è¡¨å†³æ€åº¦
            detectVoteIntent(message) {
                const voteKeywords = [
                    'è¡¨å†³', 'æŠ•ç¥¨', 'æ€åº¦', 'èµæˆ', 'åå¯¹', 'æ”¯æŒ', 'ä¸åŒæ„',
                    'æ€ä¹ˆé€‰', 'å¦‚ä½•å†³å®š', 'å»ºè®®', 'ç«‹åœº', 'è§‚ç‚¹',
                    'vote', 'attitude', 'opinion', 'decision', 'recommend'
                ];
                
                const lowerMessage = message.toLowerCase();
                return voteKeywords.some(keyword => 
                    lowerMessage.includes(keyword.toLowerCase())
                );
            }
            
            async sendWebSocketMessage(userMessage, systemPrompt, isAskingVote) {
                return new Promise((resolve, reject) => {
                    try {
                        this.currentResolve = resolve;
                        this.currentReject = reject;
                        this.fullResponse = '';
                        
                        const url = this.generateWebSocketURL();
                        console.log('è¿æ¥WebSocket:', url);
                        
                        this.websocket = new WebSocket(url);
                        
                        this.websocket.onopen = () => {
                            console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                            this.isConnected = true;
                            this.updateConnectionStatus('connected');
                            
                            // æ„å»ºæ¶ˆæ¯å†å²
                            let messageHistory = [];
                            
                            if (this.messages.length <= 1) {
                                // é¦–æ¬¡å¯¹è¯ï¼ŒåŒ…å«ç³»ç»Ÿæç¤ºè¯
                                messageHistory = [
                                    {
                                        "role": "user",
                                        "content": systemPrompt
                                    },
                                    {
                                        "role": "assistant", 
                                        "content": "å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚æˆ‘å°†ä½œä¸ºä¸“ä¸šçš„åˆè§„åˆ†æåŠ©æ‰‹ï¼ŒåŸºäºä¸­å›½ç›¸å…³æ³•è§„ä¸ºæ‚¨æä¾›æ˜ç¡®çš„åˆè§„æ€§åˆ†æå’Œè¡¨å†³å»ºè®®ã€‚è¯·é—®æ‚¨å¯¹å½“å‰ææ¡ˆæœ‰ä»€ä¹ˆå…·ä½“é—®é¢˜ï¼Ÿ"
                                    },
                                    ...this.messages
                                ];
                            } else {
                                // åç»­å¯¹è¯
                                messageHistory = this.messages;
                            }
                            
                            // å¦‚æœæ˜¯è¯¢é—®è¡¨å†³æ€åº¦ï¼Œå¢å¼ºæç¤º
                            if (isAskingVote) {
                                // åœ¨æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯åæ·»åŠ å¼ºè°ƒ
                                if (messageHistory.length > 0) {
                                    const lastMessage = messageHistory[messageHistory.length - 1];
                                    if (lastMessage.role === "user") {
                                        lastMessage.content += "\n\nè¯·æŒ‰ç…§è¦æ±‚æ˜ç¡®è¡¨æ€ï¼Œç»™å‡ºå…·ä½“çš„è¡¨å†³å»ºè®®å’Œç†ç”±ã€‚";
                                    }
                                }
                            }
                            
                            const requestData = {
                                "header": {
                                    "app_id": this.getAppId(),
                                    "uid": this.deviceId + "_" + Date.now()
                                },
                                "parameter": {
                                    "chat": {
                                        "domain": "lite",
                                        "temperature": 0.7,
                                        "max_tokens": 2048
                                    }
                                },
                                "payload": {
                                    "message": {
                                        "text": messageHistory
                                    }
                                }
                            };
                            
                            console.log('å‘é€è¯·æ±‚æ•°æ®:', requestData);
                            this.websocket.send(JSON.stringify(requestData));
                            
                            this.requestTimeout = setTimeout(() => {
                                if (this.isConnected) {
                                    this.cleanup();
                                    reject(new Error('è¯·æ±‚è¶…æ—¶ï¼ˆ30ç§’ï¼‰'));
                                }
                            }, 30000);
                        };
                        
                        this.websocket.onmessage = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                
                                if (data.header.code !== 0) {
                                    this.cleanup();
                                    this.updateConnectionStatus('error');
                                    reject(new Error(`APIé”™è¯¯: ${data.header.message} (ä»£ç : ${data.header.code})`));
                                    return;
                                }
                                
                                if (data.payload && data.payload.choices && data.payload.choices.text) {
                                    const content = data.payload.choices.text[0].content;
                                    this.fullResponse += content;
                                }
                                
                                if (data.header.status === 2) {
                                    this.cleanup();
                                    this.updateConnectionStatus('disconnected');
                                    
                                    // åå¤„ç†ï¼šç¡®ä¿å›ç­”æ˜ç¡®
                                    const processedResponse = this.postProcessResponse(this.fullResponse, isAskingVote);
                                    resolve(processedResponse);
                                }
                            } catch (parseError) {
                                console.error('è§£æå“åº”å¤±è´¥:', parseError);
                                this.cleanup();
                                this.updateConnectionStatus('error');
                                reject(new Error('è§£æå“åº”å¤±è´¥: ' + parseError.message));
                            }
                        };
                        
                        this.websocket.onerror = (error) => {
                            console.error('WebSocketé”™è¯¯:', error);
                            this.cleanup();
                            this.updateConnectionStatus('error');
                            reject(new Error('WebSocketè¿æ¥é”™è¯¯'));
                        };
                        
                        this.websocket.onclose = (event) => {
                            console.log('WebSocketè¿æ¥å·²å…³é—­');
                            this.isConnected = false;
                            this.updateConnectionStatus('disconnected');
                            
                            if (this.currentReject && this.fullResponse === '') {
                                this.cleanup();
                                reject(new Error('è¿æ¥æ„å¤–å…³é—­'));
                            }
                        };
                        
                    } catch (error) {
                        this.cleanup();
                        this.updateConnectionStatus('error');
                        reject(error);
                    }
                });
            }
            
            // åå¤„ç†å“åº”ï¼Œç¡®ä¿å›ç­”æ˜ç¡®
            postProcessResponse(response, isAskingVote) {
                if (!isAskingVote) return response;
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«æ˜ç¡®çš„è¡¨æ€è¯æ±‡
                const hasClearAttitude = /(èµæˆ|åå¯¹|æ”¯æŒ|ä¸åŒæ„|å»ºè®®.*é€šè¿‡|å»ºè®®.*æ‹’ç»|è¡¨å†³æ€åº¦.*æ˜¯)/.test(response);
                
                if (!hasClearAttitude) {
                    // å¦‚æœæ²¡æœ‰æ˜ç¡®è¡¨æ€ï¼Œæ·»åŠ æ˜ç¡®çš„è¡¨æ€æ¡†æ¶
                    response += "\n\n---\nåŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘çš„æ˜ç¡®è¡¨å†³æ€åº¦æ˜¯ï¼šéœ€è¦æ›´å¤šä¿¡æ¯æ‰èƒ½åšå‡ºå‡†ç¡®åˆ¤æ–­ã€‚å»ºè®®é‡ç‚¹å…³æ³¨ä¸Šè¿°é£é™©ç‚¹ï¼Œåœ¨è·å¾—å……åˆ†ä¿¡æ¯åå†åšå†³å®šã€‚";
                }
                
                return response;
            }
            
            // ç”ŸæˆWebSocket URL
            generateWebSocketURL() {
                const apiPassword = getXunfeiAPIPassword();
                if (!apiPassword) {
                    throw new Error('æœªé…ç½®è®¯é£APIå¯†ç ');
                }
                
                const parts = apiPassword.split(':');
                if (parts.length !== 3) {
                    throw new Error('APIå¯†ç æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º: APIKey:APISecret:AppID');
                }
                
                const [apiKey, apiSecret, appId] = parts;
                const authParams = this.generateAuthParams(apiKey, apiSecret);
                const url = `wss://spark-api.xf-yun.com/v1.1/chat?${authParams}`;
                
                return url;
            }
            
            generateAuthParams(apiKey, apiSecret) {
                const date = new Date().toUTCString();
                const host = "spark-api.xf-yun.com";
                const path = "/v1.1/chat";
                const signatureOrigin = `host: ${host}\ndate: ${date}\nGET ${path} HTTP/1.1`;
                
                const signature = CryptoJS.HmacSHA256(signatureOrigin, apiSecret);
                const signatureBase64 = CryptoJS.enc.Base64.stringify(signature);
                
                const authorizationOrigin = `api_key="${apiKey}", algorithm="hmac-sha256", headers="host date request-line", signature="${signatureBase64}"`;
                const authorization = btoa(authorizationOrigin);
                
                const params = new URLSearchParams({
                    authorization: authorization,
                    date: date,
                    host: host
                });
                
                return params.toString();
            }
            
            getAppId() {
                const apiPassword = getXunfeiAPIPassword();
                if (!apiPassword) return 'default_app_id';
                const parts = apiPassword.split(':');
                return parts.length === 3 ? parts[2] : 'default_app_id';
            }
            
            updateConversationDisplay() {
                const conversationInfo = document.getElementById('conversationInfo');
                if (conversationInfo) {
                    conversationInfo.innerHTML = `å¯¹è¯ç»Ÿè®¡: å·²è¿›è¡Œ <span id="conversationCount">${this.conversationCount}</span> è½®å¯¹è¯`;
                }
            }
            
            cleanup() {
                if (this.requestTimeout) {
                    clearTimeout(this.requestTimeout);
                    this.requestTimeout = null;
                }
                if (this.websocket && this.isConnected) {
                    this.websocket.close();
                }
                this.currentResolve = null;
                this.currentReject = null;
                this.isConnected = false;
            }
            
            updateConnectionStatus(status) {
                if (!connectionStatus) return;
                
                connectionStatus.className = 'connection-status';
                switch(status) {
                    case 'connected':
                        connectionStatus.textContent = 'å·²è¿æ¥';
                        connectionStatus.classList.add('status-connected');
                        break;
                    case 'disconnected':
                        connectionStatus.textContent = 'æœªè¿æ¥';
                        connectionStatus.classList.add('status-disconnected');
                        break;
                    case 'error':
                        connectionStatus.textContent = 'è¿æ¥é”™è¯¯';
                        connectionStatus.classList.add('status-error');
                        break;
                }
            }
            
            getStats() {
                return {
                    totalConversations: this.conversationCount,
                    userMessages: this.messages.filter(m => m.role === 'user').length,
                    aiMessages: this.messages.filter(m => m.role === 'assistant').length,
                    totalMessages: this.messages.length,
                    deviceId: this.deviceId
                };
            }
            
            clearHistory() {
                this.messages = [];
                this.conversationCount = 0;
                this.updateConversationDisplay();
            }
            
            getFullHistory() {
                return [...this.messages];
            }
            
            disconnect() {
                this.cleanup();
                this.updateConnectionStatus('disconnected');
            }
        }

        // è·å–å½“å‰ææ¡ˆæ ‡é¢˜
        function getCurrentProposalTitle() {
            if (experimentState.currentProposalIndex < experimentState.proposals.length) {
                return experimentState.proposals[experimentState.currentProposalIndex].title;
            }
            return 'æœªçŸ¥ææ¡ˆ';
        }

        // å¼•å¯¼é—®é¢˜å¤„ç†
        function askGuideQuestion(question) {
            document.getElementById('userInput').value = question;
            handleAIChat();
        }

        // AIå¯¹è¯å¤„ç†
        async function handleAIChat() {
            const message = userInput.value.trim();
            
            console.log('å¼€å§‹AIå¯¹è¯å¤„ç†ï¼Œæ¶ˆæ¯:', message);
            console.log('å½“å‰é˜¶æ®µ:', experimentState.currentPhase);
            console.log('AIç®¡ç†å™¨çŠ¶æ€:', experimentState.aiManager ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–');
            
            if (!message) {
                console.log('æ¶ˆæ¯ä¸ºç©ºï¼Œè¿”å›');
                return;
            }
            
            // æ£€æŸ¥APIé…ç½®
            const apiPassword = getXunfeiAPIPassword();
            console.log('APIå¯†ç çŠ¶æ€:', apiPassword ? 'å·²é…ç½®' : 'æœªé…ç½®');
            
            if (!apiPassword) {
                alert('è¯·å…ˆé…ç½®è®¯é£æ˜Ÿç«APIPasswordæ‰èƒ½ä½¿ç”¨AIåŠ©æ‰‹åŠŸèƒ½');
                return;
            }
            
            // æ£€æŸ¥AIç®¡ç†å™¨
            if (!experimentState.aiManager) {
                alert('AIåŠ©æ‰‹æœªåˆå§‹åŒ–');
                return;
            }

            try {
                // ç¦ç”¨è¾“å…¥æ¡†å’ŒæŒ‰é’®
                userInput.disabled = true;
                sendButton.disabled = true;
                sendButton.textContent = 'å‘é€ä¸­...';
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
                addMessageToChat(message, 'user');
                experimentState.aiInteractions++;
                updateParticipantAIInteractions();

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingMessage = addMessageToChat('AIåŠ©æ‰‹æ­£åœ¨æ€è€ƒä¸­...', 'ai');
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                userInput.value = '';
                
                // ä½¿ç”¨å¯¹è¯ç®¡ç†å™¨å‘é€æ¶ˆæ¯
                const aiResponse = await experimentState.aiManager.sendMessage(message);
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯ï¼Œæ·»åŠ çœŸå®å›å¤
                chatContainer.removeChild(loadingMessage);
                addMessageToChat(aiResponse, 'ai');
                
            } catch (error) {
                console.error('AIè°ƒç”¨é”™è¯¯:', error);
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                const loadingMessages = chatContainer.querySelectorAll('.ai-message');
                const lastMessage = loadingMessages[loadingMessages.length - 1];
                if (lastMessage && lastMessage.textContent === 'AIåŠ©æ‰‹æ­£åœ¨æ€è€ƒä¸­...') {
                    chatContainer.removeChild(lastMessage);
                }
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                let errorMessage = 'æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ã€‚';
                if (error.message.includes('HTTPé”™è¯¯')) {
                    errorMessage += ' ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚';
                } else if (error.message.includes('APIé”™è¯¯') || error.message.includes('è®¯é£APIé”™è¯¯')) {
                    errorMessage += ' APIæœåŠ¡å¼‚å¸¸: ' + error.message;
                } else if (error.message.includes('CORS')) {
                    errorMessage += ' è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ï¼Œè¯·å°è¯•ä½¿ç”¨å…¶ä»–æµè§ˆå™¨æˆ–é…ç½®CORSã€‚';
                } else if (error.message.includes('è¶…æ—¶')) {
                    errorMessage += ' è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                } else if (error.message.includes('WebSocket')) {
                    errorMessage += ' WebSocketè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚';
                } else {
                    errorMessage += ` é”™è¯¯è¯¦æƒ…: ${error.message}`;
                }
                
                addMessageToChat(errorMessage, 'ai');
                
            } finally {
                // é‡æ–°å¯ç”¨è¾“å…¥æ¡†
                if (experimentState.currentPhase === 'think') {
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    sendButton.textContent = 'å‘é€';
                    userInput.focus();
                }
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessageToChat(message, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            messageElement.textContent = message;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageElement;
        }

        // æ›´æ–°å‚ä¸è€…AIäº¤äº’æ¬¡æ•°
        function updateParticipantAIInteractions() {
            const participant = experimentData.participants.find(p => p.id === experimentState.participantId);
            if (participant) {
                participant.aiInteractions = experimentState.aiInteractions;
                saveExperimentData();
            }
        }

        // è®°å½•æŠ•ç¥¨
        function recordVote(vote) {
            const currentProposal = experimentState.proposals[experimentState.currentProposalIndex];
            const voteTime = new Date();
            
            const voteRecord = {
                proposalId: currentProposal.id,
                proposalTitle: currentProposal.title,
                vote: vote,
                timestamp: voteTime
            };
            
            experimentState.votes.push(voteRecord);
            
            const phaseEndTime = new Date();
            const phaseDuration = Math.round((phaseEndTime - experimentState.phaseStartTime) / 1000);
            experimentState.phaseTimes.push({
                phase: 'vote',
                duration: phaseDuration
            });
            
            setTimeout(() => {
                loadProposal(experimentState.currentProposalIndex + 1);
                startPhase('intro');
            }, 1000);
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            experimentScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            // ä¿å­˜ä¼šè¯æ•°æ®
            const sessionData = {
                participantId: experimentState.participantId,
                group: experimentState.group,
                useAI: experimentState.useAI,
                votes: [...experimentState.votes],
                phaseTimes: [...experimentState.phaseTimes],
                aiInteractions: experimentState.aiInteractions,
                riskAlertsViewed: experimentState.riskAlertsViewed,
                completionTime: new Date()
            };
            
            // å¦‚æœä½¿ç”¨äº†AIï¼Œä¿å­˜å¯¹è¯ç»Ÿè®¡
            if (experimentState.useAI && experimentState.aiManager) {
                sessionData.conversationStats = experimentState.aiManager.getStats();
                sessionData.conversationHistory = experimentState.aiManager.getFullHistory();
                
                // æ˜¾ç¤ºå¯¹è¯ç»Ÿè®¡
                const stats = sessionData.conversationStats;
                finalConversationStats.textContent = 
                    `æ€»å¯¹è¯è½®æ¬¡: ${stats.totalConversations}, ç”¨æˆ·æ¶ˆæ¯: ${stats.userMessages}, AIå›å¤: ${stats.aiMessages}`;
            }
            
            experimentData.sessions.push(sessionData);
            
            // æ›´æ–°å‚ä¸è€…å®ŒæˆçŠ¶æ€
            const participant = experimentData.participants.find(p => p.id === experimentState.participantId);
            if (participant) {
                participant.aiInteractions = experimentState.aiInteractions;
                participant.riskAlertsViewed = experimentState.riskAlertsViewed;
                participant.completionTime = new Date();
            }
            
            // ä¿å­˜æ•°æ®åˆ°localStorage
            saveExperimentData();
            
            displayPersonalResults();
            displayGroupResults();
            interactionCount.textContent = experimentState.aiInteractions;
            riskAlertCount.textContent = experimentState.riskAlertsViewed;
            displayPhaseTimes();
        }

        // æ˜¾ç¤ºä¸ªäººè¡¨å†³è®°å½•
        function displayPersonalResults() {
            personalResults.innerHTML = '';
            experimentState.votes.forEach(vote => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vote.proposalTitle}</td>
                    <td>${vote.vote === 'approve' ? 'èµæˆ' : vote.vote === 'oppose' ? 'åå¯¹' : 'å¼ƒæƒ'}</td>
                    <td>${vote.timestamp.toLocaleTimeString()}</td>
                `;
                personalResults.appendChild(row);
            });
        }

        // æ˜¾ç¤ºå°ç»„å†³ç­–ç»“æœ
        function displayGroupResults() {
            groupResults.innerHTML = '';
            experimentState.votes.forEach(vote => {
                const approveCount = Math.floor(Math.random() * 5) + 3;
                const opposeCount = Math.floor(Math.random() * 3) + 1;
                const abstainCount = Math.floor(Math.random() * 2);
                const aiVote = Math.random() > 0.5 ? 'èµæˆ' : 'åå¯¹';
                const totalVotes = approveCount + opposeCount + abstainCount + 1;
                const passed = approveCount / totalVotes >= 2/3;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vote.proposalTitle}</td>
                    <td>${approveCount}</td>
                    <td>${opposeCount}</td>
                    <td>${abstainCount}</td>
                    <td>${aiVote}</td>
                    <td>${passed ? 'é€šè¿‡' : 'æœªé€šè¿‡'}</td>
                `;
                groupResults.appendChild(row);
            });
        }

        // æ˜¾ç¤ºé˜¶æ®µç”¨æ—¶
        function displayPhaseTimes() {
            let timesText = '';
            experimentState.phaseTimes.forEach((phaseTime, index) => {
                const phaseName = phaseTime.phase === 'intro' ? 'ä»‹ç»' : 
                                phaseTime.phase === 'think' ? 'æ€è€ƒ' : 'è¡¨å†³';
                timesText += `ææ¡ˆ${Math.floor(index/3)+1}-${phaseName}: ${phaseTime.duration}ç§’; `;
            });
            phaseTimesDisplay.textContent = timesText || 'æš‚æ— æ•°æ®';
        }

        // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
        function updateAPIStatus() {
            const apiStatus = document.getElementById('apiStatus');
            const hasAPIPassword = !!getXunfeiAPIPassword();
            
            if (apiStatus) {
                apiStatus.textContent = hasAPIPassword ? 
                    'âœ… AIåŠ©æ‰‹å·²å°±ç»ª (è®¯é£æ˜Ÿç«Spark Lite)' : 
                    'âŒ æœªé…ç½®APIPasswordï¼ŒAIåŠ©æ‰‹ä¸å¯ç”¨';
                apiStatus.style.color = hasAPIPassword ? '#27ae60' : '#e74c3c';
            }
        }

        // ==================== ç®¡ç†åå°åŠŸèƒ½ ====================
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        // åŠ è½½ç®¡ç†åå°æ•°æ®
        function loadAdminData() {
            updateAdminStats();
            updateGroupStatsTable();
            updateParticipantDataTable();
            updateGroupDecisionTable();
            updateDetailedRecordsTable();
        }

        // æ›´æ–°ç®¡ç†åå°ç»Ÿè®¡
        function updateAdminStats() {
            const stats = experimentData.globalStats;
            const adminTotalParticipants = document.getElementById('adminTotalParticipants');
            const adminHumanAiCount = document.getElementById('adminHumanAiCount');
            const adminHumanOnlyCount = document.getElementById('adminHumanOnlyCount');
            const adminAIUsers = document.getElementById('adminAIUsers');
            
            if (adminTotalParticipants) adminTotalParticipants.textContent = stats.totalParticipants;
            if (adminHumanAiCount) adminHumanAiCount.textContent = stats.humanAiGroup;
            if (adminHumanOnlyCount) adminHumanOnlyCount.textContent = stats.humanOnlyGroup;
            if (adminAIUsers) adminAIUsers.textContent = stats.totalParticipants; // æ‰€æœ‰äººéƒ½ä½¿ç”¨AI
        }

        // æ›´æ–°åˆ†ç»„ç»Ÿè®¡è¡¨æ ¼
        function updateGroupStatsTable() {
            const stats = experimentData.globalStats;
            const groupStatsTable = document.getElementById('groupStatsTable');
            
            if (!groupStatsTable) return;
            
            let html = '';

            html += `<tr>
                <td>äººæœºåä½œç»„</td>
                <td>${stats.humanAiGroup}</td>
                <td>${stats.humanAiGroup}</td>
                <td>100%</td>
            </tr>`;

            html += `<tr>
                <td>å…¨äººç±»ç»„</td>
                <td>${stats.humanOnlyGroup}</td>
                <td>${stats.humanOnlyGroup}</td>
                <td>100%</td>
            </tr>`;

            groupStatsTable.innerHTML = html;
        }

        // æ›´æ–°å‚ä¸è€…æ•°æ®è¡¨æ ¼
        function updateParticipantDataTable() {
            const participantDataTable = document.getElementById('participantDataTable');
            if (!participantDataTable) return;
            
            let html = '';
            if (experimentData.participants.length === 0) {
                html = `<tr><td colspan="6" style="text-align: center; color: #999;">æš‚æ— å‚ä¸è€…æ•°æ®</td></tr>`;
            } else {
                experimentData.participants.forEach(participant => {
                    html += `<tr>
                        <td>${participant.id}</td>
                        <td>${participant.group.label}</td>
                        <td>${participant.role}</td>
                        <td>${participant.aiInteractions || 0}</td>
                        <td>${participant.riskAlertsViewed || 0}</td>
                        <td>${participant.completionTime ? new Date(participant.completionTime).toLocaleString() : 'è¿›è¡Œä¸­'}</td>
                    </tr>`;
                });
            }
            participantDataTable.innerHTML = html;
        }

        // æ›´æ–°åˆ†ç»„å†³ç­–è¡¨æ ¼
        function updateGroupDecisionTable() {
            const groupDecisionTable = document.getElementById('groupDecisionTable');
            if (!groupDecisionTable) return;
            
            let html = '';
            if (experimentData.sessions.length === 0) {
                html = `<tr><td colspan="7" style="text-align: center; color: #999;">æš‚æ— å†³ç­–æ•°æ®</td></tr>`;
            } else {
                experimentData.sessions.forEach(session => {
                    session.votes.forEach(vote => {
                        html += `<tr>
                            <td>${session.group.label}</td>
                            <td>${vote.proposalTitle}</td>
                            <td>${vote.vote === 'approve' ? 1 : 0}</td>
                            <td>${vote.vote === 'oppose' ? 1 : 0}</td>
                            <td>${vote.vote === 'abstain' ? 1 : 0}</td>
                            <td>${session.group.groupType === 'human-ai' ? (Math.random() > 0.5 ? 'èµæˆ' : 'åå¯¹') : 'æ— '}</td>
                            <td>${vote.vote === 'approve' ? 'é€šè¿‡' : 'æœªé€šè¿‡'}</td>
                        </tr>`;
                    });
                });
            }
            groupDecisionTable.innerHTML = html;
        }

        // æ›´æ–°è¯¦ç»†è®°å½•è¡¨æ ¼
        function updateDetailedRecordsTable() {
            const detailedRecordsTable = document.getElementById('detailedRecordsTable');
            if (!detailedRecordsTable) return;
            
            let html = '';
            if (experimentData.sessions.length === 0) {
                html = `<tr><td colspan="6" style="text-align: center; color: #999;">æš‚æ— è¯¦ç»†è®°å½•</td></tr>`;
            } else {
                experimentData.sessions.forEach(session => {
                    session.votes.forEach(vote => {
                        const phaseTimes = session.phaseTimes ? session.phaseTimes.map(pt => 
                            `${pt.phase}:${pt.duration}s`).join('; ') : 'æ— è®°å½•';
                        const aiInteractions = session.aiInteractions > 0 ? 
                            `${session.aiInteractions}æ¬¡äº¤äº’` : 'æ— äº¤äº’';
                        
                        html += `<tr>
                            <td>${session.participantId}</td>
                            <td>${vote.proposalTitle}</td>
                            <td>${vote.vote === 'approve' ? 'èµæˆ' : vote.vote === 'oppose' ? 'åå¯¹' : 'å¼ƒæƒ'}</td>
                            <td>${phaseTimes}</td>
                            <td>${aiInteractions}</td>
                            <td>${new Date(vote.timestamp).toLocaleString()}</td>
                        </tr>`;
                    });
                });
            }
            detailedRecordsTable.innerHTML = html;
        }

        // æ•°æ®å¯¼å‡ºåŠŸèƒ½
        function exportParticipantData() {
            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" +
                "å‚ä¸è€…ID,åˆ†ç»„,è§’è‰²,AIäº¤äº’æ¬¡æ•°,é£é™©æç¤ºæŸ¥çœ‹,å®Œæˆæ—¶é—´\n" +
                experimentData.participants.map(p => 
                    `"${p.id}","${p.group.label}","${p.role}","${p.aiInteractions || 0}","${p.riskAlertViews || 0}","${p.completionTime ? new Date(p.completionTime).toLocaleString() : 'è¿›è¡Œä¸­'}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "participant_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAllData() {
            exportParticipantData();
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem(STORAGE_KEYS.EXPERIMENT_DATA);
                experimentData = initializeExperimentData();
                saveExperimentData();
                loadAdminData();
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }

        // è¿”å›ç™»å½•é€‰æ‹©
        function showLoginSelection() {
            participantLoginScreen.classList.add('hidden');
            adminLoginScreen.classList.add('hidden');
            experimentScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            adminScreen.classList.add('hidden');
            loginSelectionScreen.classList.remove('hidden');
        }

        // åˆè§„çŸ¥è¯†åº“
        const complianceKnowledge = {
            "å…³è”äº¤æ˜“": {
                rules: ["æ ¹æ®ã€Šä¸Šå¸‚å…¬å¸æ²»ç†å‡†åˆ™ã€‹ï¼Œé‡å¤§å…³è”äº¤æ˜“å¿…é¡»ç»è¿‡ç‹¬ç«‹è‘£äº‹è®¤å¯", "å…³è”äº¤æ˜“åº”å½“è˜è¯·ç‹¬ç«‹è´¢åŠ¡é¡¾é—®å‘è¡¨æ„è§", "å…³è”äº¤æ˜“å®šä»·åº”å½“å…¬å…"],
                risks: ["æœªè˜è¯·ç‹¬ç«‹è´¢åŠ¡é¡¾é—®å¯èƒ½å¯¼è‡´äº¤æ˜“å®šä»·ä¸å…¬å…", "æœªå……åˆ†æŠ«éœ²å…³è”æ–¹å…³ç³»å¯èƒ½è¿åä¿¡æ¯æŠ«éœ²è§„å®š", "å¯èƒ½æŸå®³ä¸Šå¸‚å…¬å¸åˆ©ç›Š"]
            },
            "æ ‡çš„å…¬å¸äºæŸ": {
                rules: ["æ”¶è´­äºæŸä¼ä¸šéœ€å……åˆ†è®ºè¯å•†ä¸šåˆç†æ€§", "åº”å½“è¯„ä¼°æ”¶è´­åå¯¹å…¬å¸è´¢åŠ¡çŠ¶å†µçš„å½±å“", "éœ€åˆ¶å®šæ˜ç¡®çš„æ‰­äºä¸ºç›ˆè®¡åˆ’"],
                risks: ["å¯èƒ½æ‹–ç´¯ä¸Šå¸‚å…¬å¸æ•´ä½“ä¸šç»©", "å•†èª‰å‡å€¼é£é™©", "æŠ•èµ„è€…ä¿¡å¿ƒå—æŸ"]
            },
            "æˆ¿åœ°äº§è¡Œä¸šé£é™©": {
                rules: ["éœ€è¯„ä¼°è¡Œä¸šå‘¨æœŸæ€§é£é™©", "åº”å½“åˆ†ææ”¿ç­–è°ƒæ§å½±å“", "éœ€è€ƒè™‘å¸‚åœºä¾›éœ€å˜åŒ–"],
                risks: ["è¡Œä¸šä¸‹è¡Œå‘¨æœŸé£é™©", "æ”¿ç­–è°ƒæ§é£é™©", "èµ„é‡‘æµåŠ¨æ€§é£é™©"]
            },
            "äº¤æ˜“å®šä»·å…¬å…æ€§": {
                rules: ["å…³è”äº¤æ˜“å®šä»·åº”å½“å‚ç…§å¸‚åœºå…¬å…ä»·å€¼", "åº”å½“è˜è¯·ç‹¬ç«‹è¯„ä¼°æœºæ„è¿›è¡Œè¯„ä¼°", "éœ€è¯´æ˜å®šä»·ä¾æ®å’Œåˆç†æ€§"],
                risks: ["å¯èƒ½æŸå®³ä¸­å°è‚¡ä¸œåˆ©ç›Š", "æ¶‰å«Œåˆ©ç›Šè¾“é€", "ç›‘ç®¡é—®è¯¢é£é™©"]
            },
            "æŠ€æœ¯å‡ºå£ç®¡åˆ¶": {
                rules: ["æ•æ„ŸæŠ€æœ¯å‡ºå£éœ€è·å¾—å•†åŠ¡éƒ¨ç›¸å…³è®¸å¯è¯", "å‡ºå£ç®¡åˆ¶æŠ€æœ¯éœ€è¿›è¡Œåˆè§„å®¡æŸ¥", "æŠ€æœ¯å‡ºå£åˆåŒéœ€æ˜ç¡®åˆè§„è´£ä»»"],
                risks: ["æœªç»è®¸å¯å‡ºå£ç®¡åˆ¶æŠ€æœ¯å¯èƒ½å¯¼è‡´è¡Œæ”¿å¤„ç½š", "æŠ€æœ¯æ³„éœ²å¯èƒ½æŸå®³å…¬å¸æ ¸å¿ƒç«äº‰åŠ›", "å›½é™…åˆ¶è£é£é™©"]
            },
            "è·¨å¢ƒåˆè§„é£é™©": {
                rules: ["éœ€éµå®ˆç›®æ ‡å›½å®¶çš„æ•°æ®å®‰å…¨æ³•è§„", "åº”å½“è¿›è¡Œå…¨é¢çš„æ³•å¾‹å°½èŒè°ƒæŸ¥", "éœ€å»ºç«‹è·¨å¢ƒåˆè§„ç®¡ç†ä½“ç³»"],
                risks: ["è¿åå½“åœ°æ³•å¾‹æ³•è§„é£é™©", "æ•°æ®è·¨å¢ƒä¼ è¾“åˆè§„é£é™©", "çŸ¥è¯†äº§æƒä¿æŠ¤é£é™©"]
            },
            "å¤–æ±‡ç»“ç®—é£é™©": {
                rules: ["è·¨å¢ƒæ”¶æ¬¾éœ€éµå®ˆå¤–æ±‡ç®¡ç†è§„å®š", "åº”å½“è¯„ä¼°æ±‡ç‡æ³¢åŠ¨é£é™©", "éœ€å»ºç«‹å¤–æ±‡é£é™©ç®¡ç†æœºåˆ¶"],
                risks: ["æ±‡ç‡æ³¢åŠ¨å¯¼è‡´çš„è´¢åŠ¡æŸå¤±", "å¤–æ±‡ç®¡åˆ¶é£é™©", "èµ„é‡‘ç»“ç®—å»¶è¿Ÿé£é™©"]
            },
            "å›½é™…æ”¿æ²»é£é™©": {
                rules: ["éœ€è¯„ä¼°åœ°ç¼˜æ”¿æ²»é£é™©", "åº”å½“åˆ¶å®šé£é™©åº”å¯¹é¢„æ¡ˆ", "éœ€å…³æ³¨å›½é™…å…³ç³»å˜åŒ–"],
                risks: ["è´¸æ˜“æ‘©æ“¦é£é™©", "å›½é™…åˆ¶è£é£é™©", "æ”¿æ²»ä¸ç¨³å®šé£é™©"]
            }
        };

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', function() {
            if (experimentState.aiManager) {
                experimentState.aiManager.disconnect();
            }
        });
    </script>
</body>
</html>